@{
    ViewData["Title"] = "Category Management";
}

<div class="container">
    <h2 class="text-center text-success">Category Management</h2>
    <hr />

    <!-- Category Form --> 
    <form id="categoryForm">
        <input type="hidden" id="CategoryId" name="CategoryId" value="0"/>

        <div class="form-group mb-3">
            <label class="form-label">Category Name</label>
            <input type="text" class="form-control" id="Name" name="Name" required/>
        </div>

        
        <div class="mt-3 d-flex gap-3">
            <button type="submit" class="btn btn-success">S A V E</button>
            <button type="button" class="btn btn-secondary" id="btnReset">R E S E T</button>
        </div>

    </form>



    <!-- Table -->
    <h4 class="text-center mt-3 mb-3">List of Categories</h4>
    <table class="table table-bordered mt-3" id="categoryTable">
        <thead>
            <tr >
                <th style="width: 70px;" class="text-center">Sl.</th>
                <th>Name</th>
                <th style="width: 150px;">Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

</div>

@section Scripts{
    <script>

        $(document).ready(function(){

                loadCategories();

                 function loadCategories(){
                $.getJSON('/Category/GetAll', function (data){
                    let rows = '';
                    let count = 1;
                    data.forEach(function (c){
                        rows +=`
                            <tr>
                                <td class="text-center">${count++}</td>
                                <td>${c.name}</td>
                                <td>
                                    <button class="btn btn-info text-white btn-edit" data-id="${c.categoryId}"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-danger btn-delete" data-id="${c.categoryId}"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    $('#categoryTable tbody').html(rows);
                });
            }

            //Save
            $('#categoryForm').submit(function(e){
                e.preventDefault();

                var formData = new FormData(this);

                $.ajax({
                    url: '/Category/Save',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(){
                        loadCategories();
                        resetForm();
                    },
                    error: function(err){
                        alert('Errror: ' + JSON.stringify (err.responseJSON ));
                    }
                });
            });

            //Reset
            function resetForm(){
                $('#CategoryId').val(0);
                $('#Name').val('');
            }
            $('#btnReset').click(resetForm);

            //Edit
            $('#categoryTable').on('click', '.btn-edit', function () {
                var id = $(this).data('id');
                $.getJSON('/Category/GetById/' + id, function (data) {
                    $('#CategoryId').val(data.categoryId);
                    $('#Name').val(data.name);
                });
            });

            // Delete
            $('#categoryTable').on('click', '.btn-delete', function () {
                if (!confirm('Are you sure you want to delete this category?')) return;

                var id = $(this).data('id');
                $.post('/Category/Delete/' + id, function (res) {
                    if (res.success) {
                        loadCategories();
                    }
                }).fail(function (xhr) {
                    let err = xhr.responseJSON?.message || "Error deleting category.";
                    alert(err);
                });
            });


        })



    </script>
}